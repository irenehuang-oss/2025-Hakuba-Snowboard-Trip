<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 東京白馬滑雪行</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    colors: { primary: '#0ea5e9' }
                }
            }
        }
    </script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { background-color: #0ea5e9; color: white; transform: scale(1.05); border-color: #0ea5e9; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans pb-24">

    <header class="relative h-[200px] flex flex-col items-center justify-center text-white bg-slate-900 overflow-hidden">
        <img src="https://images.unsplash.com/photo-1551524559-8af4e6624178?q=80&w=2626&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-60">
        <div class="relative z-10 text-center px-4">
            <h1 class="text-3xl font-bold drop-shadow-md">2026 東京白馬滑雪</h1>
            <div id="countdown" class="mt-2 text-sm font-mono bg-black/30 px-3 py-1 rounded-full backdrop-blur-sm">Loading...</div>
        </div>
    </header>

    <section class="relative -mt-6 mb-4 z-20 px-4">
        <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-gray-400"><i class="fas fa-cloud-sun mr-1"></i> 東京 & 白馬預報</span>
                <span id="weather-status" class="text-[10px] text-blue-500">更新中...</span>
            </div>
            <div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar snap-x" id="weather-container">
                 <div class="w-full text-center text-gray-400 text-sm py-2">正在讀取行程...</div>
            </div>
        </div>
    </section>

    <nav class="sticky top-0 z-40 bg-slate-100/95 backdrop-blur border-b border-slate-200 py-3">
        <div class="px-4 overflow-x-auto hide-scrollbar"><div class="flex gap-2" id="date-tabs"></div></div>
    </nav>

    <main class="container mx-auto px-4 py-6 max-w-2xl min-h-[50vh]" id="itinerary-content"></main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around py-3 z-50 text-xs text-gray-500">
        <a href="#" onclick="showModal(); return false;" class="flex flex-col items-center"><i class="fas fa-snowflake text-lg mb-1"></i>雪場</a>
        <a href="#" onclick="window.scrollTo({top:0,behavior:'smooth'})" class="flex flex-col items-center text-primary"><i class="fas fa-calendar-alt text-lg mb-1"></i>行程</a>
        <a href="https://maps.app.goo.gl/placeholder" target="_blank" class="flex flex-col items-center"><i class="fas fa-location-arrow text-lg mb-1"></i>導航</a>
    </div>

    <div id="resort-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 relative">
            <button onclick="document.getElementById('resort-modal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-400"><i class="fas fa-times"></i></button>
            <h3 class="font-bold text-lg mb-4">雪場比較</h3>
            <div class="space-y-3 text-sm">
                <div class="p-3 bg-green-50 rounded"><b>Sanosaka</b>: 人少、面湖、練習首選</div>
                <div class="p-3 bg-green-50 rounded"><b>栂池 (Tsugaike)</b>: 超寬綠道、新手天堂</div>
                <div class="p-3 bg-blue-50 rounded"><b>五龍 (Goryu)</b>: 基地、有夜滑、連通47</div>
                <div class="p-3 bg-red-50 rounded"><b>八方 (Happo)</b>: 奧運場地、難度高</div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ★★★ 請確認這裡還是您的 CSV 連結 ★★★
        // ============================================
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQmJ01aubtIQaCnOOaW7TbqINSX0sGE8OoewKq7uREL9lEedFC1rLWc90tHCVhmOecig-wrQH-9RPml/pub?gid=811463742&single=true&output=csv";
        
        const coords = { 
            Tokyo: { lat: 35.6895, long: 139.6917 }, 
            Hakuba: { lat: 36.6982, long: 137.8619 } 
        };

        async function fetchSheetData() {
            return new Promise((resolve) => {
                Papa.parse(SHEET_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => resolve(processSheet(res.data)),
                    error: (err) => { console.error(err); alert("CSV 讀取失敗"); }
                });
            });
        }

        // ★ 核心升級：抓取星期與備註
        function processSheet(data) {
            const grouped = {};
            data.forEach(row => {
                if (!row.Date || !row.Title) return;
                const dKey = row.Date.trim(); 
                
                if (!grouped[dKey]) {
                    // 1. 處理地點判斷 (天氣用)
                    const loc = row.Location || "";
                    const isHakuba = loc.includes("白馬") || loc.toLowerCase().includes("hakuba");
                    
                    // 2. 處理星期：把 "週一" 變成 "一"
                    let dayChar = (row.Day || "").replace("週", "").trim(); 
                    if(dayChar === "") dayChar = ""; // 防止空白

                    // 3. 處理按鈕備註：偵測關鍵字
                    let tag = "";
                    if (loc.includes("移動")) tag = "移動日";
                    else if (loc.includes("會合")) tag = "會合日";
                    else if (loc.includes("新年") || loc.includes("跨年")) tag = "新年";
                    else if (loc.includes("飛行")) tag = "飛行日";
                    
                    grouped[dKey] = {
                        date: dKey,
                        dayChar: dayChar, // 存起來：星期幾
                        tag: tag,         // 存起來：特殊備註
                        cityKey: isHakuba ? "Hakuba" : "Tokyo",
                        location: isHakuba ? "白馬 Hakuba" : "東京 Tokyo", // 標題顯示用
                        weather: { temp: "N/A", icon: "fa-calendar", status: "預報未出" },
                        details: []
                    };
                }

                // 如果同一天後面有出現更重要的關鍵字，也可以更新 tag (例如第一行沒寫移動，第二行寫了)
                const loc = row.Location || "";
                if (!grouped[dKey].tag) {
                     if (loc.includes("移動")) grouped[dKey].tag = "移動日";
                     else if (loc.includes("會合")) grouped[dKey].tag = "會合日";
                     else if (loc.includes("新年") || loc.includes("跨年")) grouped[dKey].tag = "新年";
                }

                const iconRaw = (row.Icon || "fa-circle").trim();
                const iconHtml = iconRaw.startsWith("fa-") ? `<i class="fas ${iconRaw}"></i>` : `<span class="text-xl">${iconRaw}</span>`;

                grouped[dKey].details.push({
                    time: row.Time, title: row.Title, desc: row.Desc, link: row.Link, iconHtml: iconHtml
                });
            });
            return Object.values(grouped);
        }

        async function fetchWeather(daysData) {
            const urlBase = "https://api.open-meteo.com/v1/forecast?daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&forecast_days=16";
            const urls = {
                Tokyo: `${urlBase}&latitude=${coords.Tokyo.lat}&longitude=${coords.Tokyo.long}`,
                Hakuba: `${urlBase}&latitude=${coords.Hakuba.lat}&longitude=${coords.Hakuba.long}`
            };

            try {
                const [resTok, resHak] = await Promise.all([fetch(urls.Tokyo), fetch(urls.Hakuba)]);
                const db = { Tokyo: await resTok.json(), Hakuba: await resHak.json() };
                
                document.getElementById('weather-status').innerText = "已更新";

                daysData.forEach(day => {
                    const cityData = db[day.cityKey];
                    if (!cityData || !cityData.daily) return;

                    const targetMMDD = day.date.replace('/', '-'); 
                    const timeList = cityData.daily.time; 
                    const matchIndex = timeList.findIndex(t => t.endsWith(targetMMDD));

                    if (matchIndex !== -1) {
                        const min = Math.round(cityData.daily.temperature_2m_min[matchIndex]);
                        const max = Math.round(cityData.daily.temperature_2m_max[matchIndex]);
                        const rain = cityData.daily.precipitation_probability_max[matchIndex];
                        const code = cityData.daily.weathercode[matchIndex];

                        day.weather.temp = `${min}°~${max}°`;
                        day.weather.status = rain > 0 ? `${rain}% 降水` : "好天氣";
                        day.weather.icon = getWeatherIcon(code);
                    }
                });
            } catch (e) { console.error("天氣失敗", e); }
        }

        function getWeatherIcon(code) {
            if (code <= 1) return "fa-sun text-orange-400";
            if (code <= 3) return "fa-cloud-sun text-gray-400";
            if (code <= 67) return "fa-cloud-rain text-blue-400";
            if (code <= 86) return "fa-snowflake text-cyan-300";
            return "fa-cloud text-gray-400";
        }

        function render(data) {
            const wContainer = document.getElementById('weather-container');
            const tContainer = document.getElementById('date-tabs');
            const cContainer = document.getElementById('itinerary-content');
            
            wContainer.innerHTML = ""; tContainer.innerHTML = ""; cContainer.innerHTML = "";

            data.forEach((day, idx) => {
                // Weather Card
                const isSnow = day.weather.icon.includes('snowflake');
                const bg = isSnow ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100';
                wContainer.innerHTML += `
                    <div class="snap-start shrink-0 w-28 ${bg} rounded-xl p-3 flex flex-col items-center justify-center border shadow-sm">
                        <span class="text-[10px] text-gray-400 font-bold mb-1">${day.date} ${day.cityKey}</span>
                        <i class="fas ${day.weather.icon} text-2xl mb-1"></i>
                        <span class="font-bold text-slate-700 text-sm">${day.weather.temp}</span>
                        <span class="text-[10px] text-gray-500">${day.weather.status}</span>
                    </div>`;

                // ★ Tab 按鈕升級：加入星期與備註
                // 使用 flex-col 讓日期在上面，備註在下面
                const btn = document.createElement('button');
                btn.className = `snap-start shrink-0 px-4 py-1.5 h-auto rounded-xl text-sm border border-slate-200 bg-white text-slate-500 transition-all flex flex-col items-center justify-center min-w-[80px]`;
                
                // 組合 HTML：日期 + (星期) + 備註
                let btnHtml = `<span class="font-bold leading-none mb-1">${day.date} <span class="text-xs font-normal">(${day.dayChar})</span></span>`;
                
                if (day.tag) {
                    // 如果有備註 (如移動日)，顯示一個小標籤
                    btnHtml += `<span class="text-[10px] bg-slate-100 text-slate-600 px-1.5 rounded-full leading-tight">${day.tag}</span>`;
                } else {
                    // 為了版面整齊，沒有備註也可以放一個空白佔位，或者就留白
                    // btnHtml += `<span class="text-[10px] text-transparent">.</span>`; // 這樣按鈕會等高
                }

                btn.innerHTML = btnHtml;
                btn.onclick = () => switchTab(idx);
                tContainer.appendChild(btn);

                // Content
                const content = document.createElement('div');
                content.id = `day-${idx}`;
                content.className = `hidden animate-fade-in`;
                
                let html = `<h2 class="text-2xl font-bold mb-4">${day.location} <span class="text-sm font-normal text-gray-500 ml-2">${day.date} (${day.dayChar})</span></h2><div class="space-y-4">`;
                day.details.forEach(item => {
                    html += `
                        <div class="flex gap-4 relative pb-6 group">
                            <div class="absolute left-[19px] top-8 bottom-0 w-0.5 bg-slate-200"></div>
                            <div class="relative shrink-0 w-10 h-10 rounded-full bg-white border-2 border-slate-100 flex items-center justify-center text-primary z-10 overflow-hidden shadow-sm">
                                ${item.iconHtml}
                            </div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-50 flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800">${item.title}</h3>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">${item.time}</span>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">${item.desc || ""}</p>
                                ${item.link ? `<a href="${item.link}" target="_blank" class="inline-block mt-2 text-xs text-primary underline">開啟連結</a>` : ''}
                            </div>
                        </div>`;
                });
                html += `</div>`;
                content.innerHTML = html;
                cContainer.appendChild(content);
            });

            switchTab(0);
        }

        function switchTab(idx) {
            const tabs = document.getElementById('date-tabs').children;
            const contents = document.getElementById('itinerary-content').children;
            for(let i=0; i<tabs.length; i++) {
                if(i===idx) {
                    tabs[i].classList.add('tab-active', 'bg-primary', 'text-white');
                    tabs[i].classList.remove('bg-white', 'text-slate-500');
                    // 讓標籤變白色
                    const tagSpan = tabs[i].querySelector('span.bg-slate-100');
                    if(tagSpan) { tagSpan.classList.remove('bg-slate-100', 'text-slate-600'); tagSpan.classList.add('bg-white/20', 'text-white'); }
                    
                    contents[i].classList.remove('hidden');
                    tabs[i].scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
                } else {
                    tabs[i].classList.remove('tab-active', 'bg-primary', 'text-white');
                    tabs[i].classList.add('bg-white', 'text-slate-500');
                     // 標籤變回灰色
                    const tagSpan = tabs[i].querySelector('span.bg-white\\/20');
                    if(tagSpan) { tagSpan.classList.remove('bg-white/20', 'text-white'); tagSpan.classList.add('bg-slate-100', 'text-slate-600'); }

                    contents[i].classList.add('hidden');
                }
            }
        }

        function showModal() { document.getElementById('resort-modal').classList.remove('hidden'); }

        (async () => {
            const data = await fetchSheetData();
            if(data.length > 0) {
                render(data); 
                await fetchWeather(data); 
                render(data); 
            }
            const target = new Date("2025-12-21T16:00:00").getTime();
            setInterval(() => {
                const diff = target - new Date().getTime();
                const d = Math.floor(diff / (1000*60*60*24));
                const h = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
                document.getElementById('countdown').innerText = `倒數 ${d} 天 ${h} 時`;
            }, 1000);
        })();
    </script>
</body>
</html>
