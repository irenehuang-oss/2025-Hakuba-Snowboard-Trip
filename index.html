<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 東京白馬滑雪行</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    colors: {
                        ice: '#f0f9ff',
                        primary: '#0ea5e9',
                        dark: '#0f172a',
                    }
                }
            }
        }
    </script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active {
            background-color: #0ea5e9;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.4);
            transform: scale(1.05);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #0ea5e9;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans pb-24">

    <header class="relative h-[25vh] min-h-[200px] flex flex-col items-center justify-center text-white overflow-hidden bg-slate-900">
        <img src="https://images.unsplash.com/photo-1551524559-8af4e6624178?q=80&w=2626&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-60" alt="Background">
        <div class="relative z-10 text-center px-4 mt-4">
            <h1 class="text-2xl md:text-4xl font-bold drop-shadow-lg">2026 東京白馬滑雪</h1>
            <div id="countdown" class="mt-2 text-sm md:text-base font-mono bg-black/30 px-3 py-1 rounded-full inline-block backdrop-blur-sm">
                Loading...
            </div>
        </div>
    </header>

    <section class="relative -mt-8 mb-6 z-20 px-4">
        <div class="bg-white rounded-xl shadow-lg p-4 overflow-hidden">
            <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center justify-between">
                <span><i class="fas fa-cloud-sun mr-2"></i> 當地預報 (14天內)</span>
                <span id="weather-status" class="text-[10px] text-blue-500 flex items-center"><div class="loader mr-1"></div> 更新資料中...</span>
            </h3>
            <div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar snap-x" id="weather-container">
                 <div class="text-center w-full py-4 text-gray-400 text-sm">正在讀取 Google Sheet 行程...</div>
            </div>
        </div>
    </section>

    <nav class="sticky top-0 z-40 bg-slate-100/95 backdrop-blur-md border-b border-slate-200 shadow-sm py-3 transition-all">
        <div class="px-4">
            <div class="flex overflow-x-auto gap-3 hide-scrollbar snap-x py-1" id="date-tabs">
                </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-6 max-w-2xl min-h-[50vh]" id="itinerary-content">
        </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around py-3 z-50 text-xs text-gray-500 safe-area-bottom shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <a href="#" onclick="showResortInfo(); return false;" class="flex flex-col items-center hover:text-primary transition-colors">
            <i class="fas fa-snowflake text-lg mb-1"></i>
            <span>雪場資訊</span>
        </a>
        <a href="#" onclick="window.scrollTo({top:0, behavior:'smooth'})" class="flex flex-col items-center hover:text-primary text-primary transition-colors">
            <i class="fas fa-calendar-alt text-lg mb-1"></i>
            <span>每日行程</span>
        </a>
        <a href="https://www.google.com/maps" target="_blank" class="flex flex-col items-center hover:text-primary transition-colors">
            <i class="fas fa-map-marked-alt text-lg mb-1"></i>
            <span>導航</span>
        </a>
    </div>

    <div id="resort-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white rounded-2xl w-full max-w-md max-h-[80vh] overflow-y-auto p-6 relative shadow-2xl">
            <button onclick="document.getElementById('resort-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold mb-6 flex items-center"><i class="fas fa-skiing mr-2 text-primary"></i> 雪場快速比較</h2>
            <div class="space-y-4">
                <div class="bg-green-50 p-4 rounded-xl border border-green-100"><h3 class="font-bold text-green-800">Sanosaka</h3><p class="text-sm">人少、面湖景、練習首選。</p></div>
                <div class="bg-green-50 p-4 rounded-xl border border-green-100"><h3 class="font-bold text-green-800">Tsugaike (栂池)</h3><p class="text-sm">超寬綠道、新手天堂。</p></div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><h3 class="font-bold text-blue-800">Goryu (五龍)</h3><p class="text-sm">有夜滑、地形豐富、基地。</p></div>
                <div class="bg-red-50 p-4 rounded-xl border border-red-100"><h3 class="font-bold text-red-800">Happo-One (八方)</h3><p class="text-sm">奧運場地、難度高。</p></div>
            </div>
        </div>
    </div>

<script>
        // ============================================
        // ★★★ 請確認這裡還是您的 CSV 連結 ★★★
        // ============================================
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT5K_gYnQ5fW-l9q4X_Zc1Xq-R5fX-h8Xq-N6fX-p9X-k3X-o8X-q7X-r5X-s4X/pub?output=csv"; 
        
        const coords = {
            Tokyo: { lat: 35.6895, long: 139.6917 },
            Hakuba: { lat: 36.6982, long: 137.8619 }
        };

        // 1. 讀取 Google Sheet CSV
        async function fetchSheetData() {
            return new Promise((resolve, reject) => {
                Papa.parse(SHEET_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true, // 自動跳過空行
                    complete: function(results) {
                        resolve(processData(results.data));
                    },
                    error: function(err) {
                        console.error("CSV error", err);
                        alert("讀取失敗，請檢查 CSV 連結");
                    }
                });
            });
        }

        // 2. 資料轉換 (新增：自動修復日期與 Emoji 支援)
        function processData(rawData) {
            const groupedData = {};
            rawData.forEach(row => {
                if (!row.Date || !row.Title) return;

                // ★ 強制修剪空白，避免 Excel 多打空白鍵導致對應失敗
                const dateKey = row.Date.trim(); 
                
                if (!groupedData[dateKey]) {
                    groupedData[dateKey] = {
                        date: dateKey,
                        day: row.Day || "",
                        location: row.Location || "行程",
                        weather: { icon: "fa-spinner fa-spin", temp: "-", status: "Loading", rain: "" },
                        details: []
                    };
                }
                
                // ★ 判斷是 FontAwesome 代碼還是 Emoji
                let iconHtml = "";
                const iconValue = (row.Icon || "fa-circle").trim();
                if (iconValue.startsWith("fa-")) {
                    // 如果是 fa- 開頭，用 FontAwesome
                    iconHtml = `<i class="fas ${iconValue}"></i>`;
                } else {
                    // 否則當作 Emoji 直接顯示，並加大字體
                    iconHtml = `<span class="text-xl">${iconValue}</span>`;
                }

                groupedData[dateKey].details.push({
                    time: row.Time,
                    title: row.Title,
                    iconHtml: iconHtml, // 改存 HTML
                    desc: row.Desc || "",
                    link: row.Link || ""
                });
            });
            return Object.values(groupedData);
        }

        // 3. 天氣 API
        async function fetchWeather(data) {
            const today = new Date();
            const year = today.getFullYear();
            const urls = {
                Tokyo: `https://api.open-meteo.com/v1/forecast?latitude=${coords.Tokyo.lat}&longitude=${coords.Tokyo.long}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo`,
                Hakuba: `https://api.open-meteo.com/v1/forecast?latitude=${coords.Hakuba.lat}&longitude=${coords.Hakuba.long}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo`
            };

            try {
                const [tokyoRes, hakubaRes] = await Promise.all([fetch(urls.Tokyo), fetch(urls.Hakuba)]);
                const weatherDB = { Tokyo: await tokyoRes.json(), Hakuba: await hakubaRes.json() };
                
                document.getElementById('weather-status').innerHTML = '<i class="fas fa-check-circle"></i> 已更新';

                data.forEach(day => {
                    // 模糊比對地點
                    const locStr = day.location.toLowerCase();
                    const locKey = (locStr.includes("白馬") || locStr.includes("hakuba") || locStr.includes("sanosaka") || locStr.includes("栂池") || locStr.includes("五龍") || locStr.includes("岩岳")) ? "Hakuba" : "Tokyo";
                    
                    const wData = weatherDB[locKey].daily;
                    if (!wData) return;

                    // 日期配對邏輯
                    let currentYear = year;
                    // 如果現在是12月但行程是1月，年份+1
                    if (today.getMonth() === 11 && day.date.startsWith("1/")) currentYear = year + 1;

                    // ★ 確保日期格式為 YYYY-MM-DD (補0)
                    const parts = day.date.split('/');
                    if(parts.length < 2) return; // 格式錯誤就跳過
                    const dateStr = `${currentYear}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                    
                    const index = wData.time.indexOf(dateStr);

                    if (index !== -1) {
                        const minT = Math.round(wData.temperature_2m_min[index]);
                        const maxT = Math.round(wData.temperature_2m_max[index]);
                        const rainProb = wData.precipitation_probability_max[index];
                        const code = wData.weathercode[index];

                        day.weather.temp = `${minT}°~${maxT}°`;
                        day.weather.rain = rainProb > 0 ? `<i class="fas fa-umbrella text-blue-400"></i> ${rainProb}%` : '';
                        day.weather.icon = getWeatherIcon(code);
                        day.weather.status = getWeatherDesc(code);
                    } else {
                        day.weather.temp = "N/A";
                        day.weather.status = "預報未出";
                        day.weather.icon = "fa-calendar-day"; 
                    }
                });
            } catch (error) {
                console.error("Weather Error", error);
            }
        }

        function getWeatherIcon(code) {
            if (code <= 1) return "fa-sun text-orange-400";
            if (code <= 3) return "fa-cloud-sun text-gray-400";
            if (code <= 67) return "fa-cloud-rain text-blue-400";
            if (code <= 86) return "fa-snowflake text-cyan-300";
            return "fa-cloud";
        }
        function getWeatherDesc(code) {
            if (code <= 1) return "晴朗";
            if (code <= 3) return "多雲";
            if (code <= 67) return "有雨";
            if (code <= 86) return "降雪";
            return "陰天";
        }

        // 4. Render
        function renderApp(data) {
            const weatherContainer = document.getElementById('weather-container');
            const tabsContainer = document.getElementById('date-tabs');
            const contentContainer = document.getElementById('itinerary-content');

            // 保持 Tab 狀態
            let currentActiveIndex = 0;
            const activeTab = document.querySelector('.tab-active');
            if (activeTab) {
                 const tabs = Array.from(document.getElementById('date-tabs').children);
                 currentActiveIndex = tabs.indexOf(activeTab);
            }
            if (currentActiveIndex === -1 && data.length > 0) currentActiveIndex = 0;

            weatherContainer.innerHTML = '';
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';

            data.forEach((day, index) => {
                // 天氣卡
                const isSnow = day.weather.icon.includes('snowflake');
                const cardBg = isSnow ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100';
                weatherContainer.innerHTML += `
                    <div class="snap-start shrink-0 w-28 ${cardBg} rounded-xl p-3 flex flex-col items-center justify-center border shadow-sm">
                        <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-1">${day.date} ${day.location}</span>
                        <i class="fas ${day.weather.icon} text-2xl mb-1 mt-1"></i>
                        <span class="font-bold text-slate-700 text-sm my-1">${day.weather.temp}</span>
                        <span class="text-[10px] text-gray-500">${day.weather.status} ${day.weather.rain}</span>
                    </div>`;

                // Tab 按鈕
                const isActive = index === currentActiveIndex;
                const tabBtn = document.createElement('button');
                tabBtn.className = `snap-start shrink-0 px-5 py-2 rounded-full text-sm font-medium transition-all duration-200 border border-slate-200 whitespace-nowrap ${isActive ? 'tab-active' : 'bg-white text-slate-500'}`;
                tabBtn.innerHTML = `${day.date} <span class="text-xs opacity-70 ml-1">${day.day}</span>`;
                tabBtn.onclick = () => switchTab(index);
                tabsContainer.appendChild(tabBtn);

                // 行程內容
                const dayContent = document.createElement('div');
                dayContent.id = `day-${index}`;
                dayContent.className = `space-y-4 ${isActive ? 'block' : 'hidden'} animate-fade-in`;
                
                let contentHTML = `
                    <div class="flex items-center justify-between mb-4 mt-2">
                        <h2 class="text-2xl font-bold text-slate-800 tracking-tight">${day.location}</h2>
                        <div class="text-right"><span class="block text-xl font-bold text-primary">${day.weather.temp}</span></div>
                    </div>`;

                day.details.forEach(item => {
                    contentHTML += `
                        <div class="flex gap-4 relative pb-8 last:pb-2 group">
                            <div class="absolute left-[19px] top-8 bottom-0 w-0.5 bg-slate-200 last:hidden"></div>
                            <div class="relative shrink-0 w-10 h-10 rounded-full bg-white border-2 border-slate-100 flex items-center justify-center text-primary shadow-sm z-10 overflow-hidden">
                                ${item.iconHtml}
                            </div>
                            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-50 flex-1">
                                <div class="flex justify-between items-start mb-1">
                                    <h3 class="font-bold text-slate-800 text-base">${item.title}</h3>
                                    <span class="text-xs font-mono text-slate-400 bg-slate-50 px-2 py-1 rounded-md border border-slate-100">${item.time}</span>
                                </div>
                                <p class="text-sm text-gray-600 leading-relaxed">${item.desc}</p>
                                ${item.link ? `<a href="${item.link}" target="_blank" class="inline-flex items-center mt-3 text-xs text-white bg-primary px-3 py-1.5 rounded-lg"><i class="fas fa-location-arrow mr-1"></i> 導航</a>` : ''}
                            </div>
                        </div>`;
                });
                dayContent.innerHTML = contentHTML;
                contentContainer.appendChild(dayContent);
            });
        }

        function switchTab(selectedIndex) {
            const tabs = document.getElementById('date-tabs').children;
            const contents = document.getElementById('itinerary-content').children;
            for (let i = 0; i < tabs.length; i++) {
                if (i === selectedIndex) {
                    tabs[i].classList.add('tab-active');
                    tabs[i].classList.remove('bg-white', 'text-slate-500');
                    tabs[i].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    contents[i].classList.remove('hidden');
                } else {
                    tabs[i].classList.remove('tab-active');
                    tabs[i].classList.add('bg-white', 'text-slate-500');
                    contents[i].classList.add('hidden');
                }
            }
        }
        function showResortInfo() { document.getElementById('resort-modal').classList.remove('hidden'); }

        document.addEventListener('DOMContentLoaded', async () => {
            const data = await fetchSheetData();
            renderApp(data);
            await fetchWeather(data);
            renderApp(data);

            const targetDate = new Date("December 21, 2025 16:50:00").getTime();
            setInterval(() => {
                const dist = targetDate - new Date().getTime();
                const days = Math.floor(dist / (1000 * 60 * 60 * 24));
                const hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                document.getElementById("countdown").innerText = `倒數 ${days} 天 ${hours} 時`;
            }, 1000);
        });
    </script>
</body>
</html>
