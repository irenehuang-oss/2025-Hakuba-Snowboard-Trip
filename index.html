<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>25-26 東京白馬滑雪Trip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] },
                    colors: { primary: '#0ea5e9' }
                }
            }
        }
    </script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active { background-color: #0ea5e9; color: white; transform: scale(1.05); border-color: #0ea5e9; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans pb-24">

    <header class="relative h-[200px] flex flex-col items-center justify-center text-white bg-slate-900 overflow-hidden">
        <img src="https://images.unsplash.com/photo-1520205628238-6d0925e0a6af?q=80&w=2000&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-60">
        
        <div class="relative z-10 text-center px-4">
            <h1 id="main-title" class="text-3xl font-bold drop-shadow-md">25-26 東京白馬滑雪Trip</h1>
            <div id="countdown" class="mt-2 text-sm font-mono bg-black/30 px-3 py-1 rounded-full backdrop-blur-sm">Loading...</div>
        </div>
    </header>

    <section class="relative -mt-6 mb-4 z-20 px-4">
        <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-gray-400"><i class="fas fa-cloud-sun mr-1"></i> 東京 & 白馬預報</span>
                <span id="weather-status" class="text-[10px] text-blue-500">更新中...</span>
            </div>
            <div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar snap-x" id="weather-container">
                 <div class="w-full text-center text-gray-400 text-sm py-2">正在讀取行程...</div>
            </div>
        </div>
    </section>

    <nav class="sticky top-0 z-40 bg-slate-100/95 backdrop-blur border-b border-slate-200 py-3">
        <div class="px-4 overflow-x-auto hide-scrollbar"><div class="flex gap-2" id="date-tabs"></div></div>
    </nav>

    <main class="container mx-auto px-4 py-6 max-w-2xl min-h-[50vh]" id="itinerary-content"></main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around py-3 z-50 text-xs text-gray-500">
        <a href="#" onclick="showModal(); return false;" class="flex flex-col items-center text-primary font-bold w-1/2 border-r border-slate-100"><i class="fas fa-snowflake text-lg mb-1"></i>雪場</a>
        <a href="#" onclick="window.scrollTo({top:0,behavior:'smooth'}); closeResortModal();" class="flex flex-col items-center w-1/2 hover:text-primary transition-colors"><i class="fas fa-calendar-alt text-lg mb-1"></i>行程</a>
    </div>

    <div id="resort-modal" class="fixed inset-0 bg-slate-100 z-[60] hidden flex flex-col overflow-hidden animate-fade-in">
        <div class="bg-white px-4 py-3 flex justify-between items-center border-b border-slate-200 shadow-sm shrink-0 z-10">
            <h2 class="text-lg font-bold text-slate-800"><i class="fas fa-mountain text-primary mr-2"></i>白馬雪場攻略</h2>
            <button onclick="closeResortModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="flex-1 overflow-y-auto pb-24 bg-slate-100">
            <div class="relative h-48 w-full">
                <img src="https://images.pexels.com/photos/848599/pexels-photo-848599.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 to-transparent flex items-end p-4">
                    <h1 class="text-white text-2xl font-bold drop-shadow-md">Snowboarding in Hakuba</h1>
                </div>
            </div>
            
            <div class="p-4 space-y-4" id="resort-list"></div>
        </div>
    </div>

    <script>
        // ============================================
        // ★★★ 請確認您的 CSV 連結 ★★★
        // ============================================
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQmJ01aubtIQaCnOOaW7TbqINSX0sGE8OoewKq7uREL9lEedFC1rLWc90tHCVhmOecig-wrQH-9RPml/pub?gid=811463742&single=true&output=csv";
        
        const RESORTS = [
            {
                name: "白馬五龍 (Goryu)",
                en: "Hakuba Goryu / エイブル白馬五竜",
                tags: ["新手友善", "夜滑之王", "交通最便"],
                price: "¥8,000 (含47)",
                time: "約 3-5 分",
                level: "全程度",
                hours: "08:00 - 16:50 (夜滑 18:30 - 21:30)", 
                desc: "距離住宿地點最近，山腳 Toomi 雪道寬敞適合新手，擁有白馬最棒的夜滑場地。Base Center 設施完善 (有 Subway、溫泉)。",
                map: "https://maps.app.goo.gl/JqLbBjLt4aBBZKCQ6",
                web: "https://goryu47.com/en/"
            },
            {
                name: "Hakuba 47",
                en: "Hakuba 47 Winter Sports Park",
                tags: ["地形公園", "雪質保證", "朝北坡向"],
                price: "¥8,000 (含五龍)",
                time: "約 10-12 分",
                level: "中高級 (Park)",
                hours: "08:00 - 16:00 (無夜滑)",
                desc: "白馬最強 Park (半管、跳台)！因為坡向朝北，春季雪質通常比其他雪場好。可從五龍山頂滑過去。",
                map: "https://maps.app.goo.gl/NnW6B6g28urKYxww5",
                web: "https://www.hakuba47.co.jp/winter/en/"
            },
            {
                name: "八方尾根 (Happo-One)",
                en: "Happo-One / 白馬八方尾根",
                tags: ["奧運場地", "高手向", "景色壯觀"],
                price: "¥7,200 - 8,500",
                time: "約 15 分",
                level: "中高級 (新手不推)",
                hours: "08:00 - 16:00 (無夜滑)",
                desc: "白馬最具代表性的雪場，規模最大。充滿挑戰性的紅黑線與饅頭 (Mogul)。聯絡道較窄且平，對單板新手較吃力。",
                map: "https://maps.app.goo.gl/R4cVmfvQ7VKaHpou7",
                web: "https://www.happo-one.jp/en/"
            },
            {
                name: "栂池高原 (Tsugaike)",
                en: "Tsugaike Kogen / 栂池高原",
                tags: ["超寬綠道", "新手天堂", "DBD粉雪"],
                price: "¥7,000 - 7,500",
                time: "約 20-25 分",
                level: "初中級",
                hours: "08:00 - 16:00 (無夜滑)",
                desc: "鐘鳴之丘擁有日本最寬闊的初級滑道 (1.2km寬)，新手練習轉彎完全不怕撞。另有需上課才能進入的 DBD 粉雪樹林區。",
                map: "https://maps.app.goo.gl/WbFqqEgSiqN9qdPK7",
                web: "https://tsugaike.nippon-ski.com/en/"
            },
            {
                name: "白馬岩岳 (Iwatake)",
                en: "Hakuba Iwatake / 白馬岩岳",
                tags: ["網美鞦韆", "Carving聖地", "避風"],
                price: "¥6,500 - 7,000",
                time: "約 15-18 分",
                level: "初中級",
                hours: "08:00 - 16:00 (無夜滑)",
                desc: "地形流暢，雪道寬且順，適合練 Carving。山頂有著名的 Mountain Harbor 和網美鞦韆，必去拍照！",
                map: "https://maps.app.goo.gl/ivh4tTL9yDwb4g7M9",
                web: "https://iwatake-ski.com/"
            },
            {
                name: "白馬 Sanosaka",
                en: "White Resort Hakuba Sanosaka",
                tags: ["湖景滑雪", "人少清幽", "高CP值"],
                price: "¥4,800 - 5,500",
                time: "約 5-8 分",
                level: "初中級",
                hours: "08:00 - 16:00 (無夜滑)",
                desc: "唯一可眺望「青木湖」的雪場，景色優美。團客少，適合想要安靜練習的人。",
                map: "https://maps.app.goo.gl/Q1s8rVESDZ9VVCbA8",
                web: "https://sanosaka.jp/"
            }
        ];

        const coords = { 
            Tokyo: { lat: 35.6895, long: 139.6917 }, 
            Hakuba: { lat: 36.6982, long: 137.8619 } 
        };

        async function fetchSheetData() {
            return new Promise((resolve) => {
                Papa.parse(SHEET_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => resolve(processSheet(res.data)),
                    error: (err) => { console.error(err); alert("CSV 讀取失敗"); }
                });
            });
        }

        function processSheet(data) {
            const grouped = {};
            data.forEach(row => {
                if (!row.Date || (!row.Title && !row.Type)) return;
                const dKey = row.Date.trim(); 
                
                if (!grouped[dKey]) {
                    const locationText = row.Location || "";
                    const isHakuba = locationText.includes("白馬") || locationText.toLowerCase().includes("hakuba");
                    let dayChar = (row.Day || "").replace("週", "").trim(); 
                    
                    const parts = locationText.split(' ');
                    let tag = "";
                    if (parts.length > 1) {
                        tag = parts.slice(1).join(' ');
                    }
                    
                    grouped[dKey] = {
                        date: dKey, dayChar: dayChar, tag: tag,
                        cityKey: isHakuba ? "Hakuba" : "Tokyo",
                        location: locationText, 
                        weather: { temp: "N/A", icon: "fa-calendar", status: "預報未出" },
                        details: []
                    };
                }
                const iconRaw = (row.Icon || "fa-circle").trim();
                const iconHtml = iconRaw.startsWith("fa-") ? `<i class="fas ${iconRaw}"></i>` : `<span class="text-xl">${iconRaw}</span>`;
                const type = row.Type ? row.Type.trim().toLowerCase() : 'event';
                grouped[dKey].details.push({
                    time: row.Time || "", title: row.Title || "", desc: row.Desc, link: row.Link, iconHtml: iconHtml, type: type
                });
            });
            return Object.values(grouped);
        }

        async function fetchWeather(daysData) {
            const urlBase = "https://api.open-meteo.com/v1/forecast?daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&forecast_days=16";
            const urls = {
                Tokyo: `${urlBase}&latitude=${coords.Tokyo.lat}&longitude=${coords.Tokyo.long}`,
                Hakuba: `${urlBase}&latitude=${coords.Hakuba.lat}&longitude=${coords.Hakuba.long}`
            };

            try {
                const [resTok, resHak] = await Promise.all([fetch(urls.Tokyo), fetch(urls.Hakuba)]);
                const db = { Tokyo: await resTok.json(), Hakuba: await resHak.json() };
                document.getElementById('weather-status').innerText = "已更新";

                daysData.forEach(day => {
                    const cityData = db[day.cityKey];
                    if (!cityData || !cityData.daily) return;
                    const targetMMDD = day.date.replace('/', '-'); 
                    const timeList = cityData.daily.time; 
                    const matchIndex = timeList.findIndex(t => t.endsWith(targetMMDD));
                    if (matchIndex !== -1) {
                        const min = Math.round(cityData.daily.temperature_2m_min[matchIndex]);
                        const max = Math.round(cityData.daily.temperature_2m_max[matchIndex]);
                        const rain = cityData.daily.precipitation_probability_max[matchIndex];
                        const code = cityData.daily.weathercode[matchIndex];
                        day.weather.temp = `${min}°~${max}°`;
                        day.weather.status = rain > 0 ? `${rain}% 降水` : "好天氣";
                        day.weather.icon = getWeatherIcon(code);
                    }
                });
            } catch (e) { console.error("天氣失敗", e); }
        }

        function getWeatherIcon(code) {
            if (code <= 1) return "fa-sun text-orange-400";
            if (code <= 3) return "fa-cloud-sun text-gray-400";
            if (code <= 67) return "fa-cloud-rain text-blue-400";
            if (code <= 86) return "fa-snowflake text-cyan-300";
            return "fa-cloud text-gray-400";
        }

        function render(data) {
            const wContainer = document.getElementById('weather-container');
            const tContainer = document.getElementById('date-tabs');
            const cContainer = document.getElementById('itinerary-content');
            wContainer.innerHTML = ""; tContainer.innerHTML = ""; cContainer.innerHTML = "";

            data.forEach((day, idx) => {
                const isSnow = day.weather.icon.includes('snowflake');
                const bg = isSnow ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100';
                wContainer.innerHTML += `
                    <div class="snap-start shrink-0 w-28 ${bg} rounded-xl p-3 flex flex-col items-center justify-center border shadow-sm">
                        <span class="text-[10px] text-gray-400 font-bold mb-1">${day.date} ${day.cityKey}</span>
                        <i class="fas ${day.weather.icon} text-2xl mb-1"></i>
                        <span class="font-bold text-slate-700 text-sm">${day.weather.temp}</span>
                        <span class="text-[10px] text-gray-500">${day.weather.status}</span>
                    </div>`;

                const btn = document.createElement('button');
                btn.className = `snap-start shrink-0 px-4 py-1.5 h-auto rounded-xl text-sm border border-slate-200 bg-white text-slate-500 transition-all flex flex-col items-center justify-center min-w-[80px]`;
                let btnHtml = `<span class="font-bold leading-none mb-1">${day.date} <span class="text-xs font-normal">(${day.dayChar})</span></span>`;
                if (day.tag) {
                    btnHtml += `<span class="text-[10px] bg-slate-100 text-slate-600 px-1.5 rounded-full leading-tight">${day.tag}</span>`;
                }
                btn.innerHTML = btnHtml;
                btn.onclick = () => switchTab(idx);
                tContainer.appendChild(btn);

                const content = document.createElement('div');
                content.id = `day-${idx}`;
                content.className = `hidden animate-fade-in`;
                let html = `<h2 class="text-2xl font-bold mb-4">${day.location} <span class="text-sm font-normal text-gray-500 ml-2">${day.date} (${day.dayChar})</span></h2><div class="space-y-0">`;
                day.details.forEach((item, i) => {
                    const isLast = i === day.details.length - 1;
                    if (item.type === 'transit') {
                        html += `
                        <div class="flex relative pl-[19px]">
                            <div class="absolute left-[19px] top-0 bottom-0 w-0.5 border-l-2 border-dotted border-slate-300"></div>
                            <div class="relative z-10 my-2 ml-6">
                                <div class="inline-flex items-center bg-slate-100 border border-slate-200 rounded-full px-3 py-1 text-xs text-slate-600 shadow-sm">
                                    <span class="mr-2 text-primary">${item.iconHtml}</span>
                                    <span class="font-bold mr-2">${item.title}</span>
                                    <span class="text-slate-400">${item.desc || ""}</span>
                                </div>
                            </div>
                        </div>`;
                    } else {
                        html += `
                        <div class="flex gap-4 relative pb-6 group">
                            <div class="absolute left-[19px] top-8 bottom-0 w-0.5 bg-slate-200 ${isLast ? 'hidden' : ''}"></div>
                            <div class="relative shrink-0 w-10 h-10 rounded-full bg-white border-2 border-slate-100 flex items-center justify-center text-primary z-10 overflow-hidden shadow-sm group-hover:border-primary transition-colors">
                                ${item.iconHtml}
                            </div>
                            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-50 flex-1 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800">${item.title}</h3>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">${item.time}</span>
                                </div>
                                ${item.desc ? `<p class="text-sm text-gray-600 mt-1">${item.desc}</p>` : ''}
                                ${item.link ? `<a href="${item.link}" target="_blank" class="inline-block mt-2 text-xs text-primary underline"><i class="fas fa-location-arrow mr-1"></i>導航</a>` : ''}
                            </div>
                        </div>`;
                    }
                });
                html += `</div>`;
                content.innerHTML = html;
                cContainer.appendChild(content);
            });
            switchTab(0);
        }

        function switchTab(idx) {
            const tabs = document.getElementById('date-tabs').children;
            const contents = document.getElementById('itinerary-content').children;
            for(let i=0; i<tabs.length; i++) {
                if(i===idx) {
                    tabs[i].classList.add('tab-active', 'bg-primary', 'text-white');
                    tabs[i].classList.remove('bg-white', 'text-slate-500');
                    const tag = tabs[i].querySelector('span.bg-slate-100');
                    if(tag) { tag.classList.replace('bg-slate-100','bg-white/20'); tag.classList.replace('text-slate-600','text-white'); }
                    contents[i].classList.remove('hidden');
                    tabs[i].scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
                } else {
                    tabs[i].classList.remove('tab-active', 'bg-primary', 'text-white');
                    tabs[i].classList.add('bg-white', 'text-slate-500');
                    const tag = tabs[i].querySelector('span.bg-white\\/20');
                    if(tag) { tag.classList.replace('bg-white/20','bg-slate-100'); tag.classList.replace('text-white','text-slate-600'); }
                    contents[i].classList.add('hidden');
                }
            }
        }

        function showModal() { 
            const list = document.getElementById('resort-list');
            list.innerHTML = ""; 
            
            RESORTS.forEach(r => {
                const tagsHtml = r.tags.map(t => `<span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full mr-1">${t}</span>`).join('');
                
                const card = `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 resort-card">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-xl text-slate-800">${r.name}</h3>
                                <p class="text-xs text-gray-400">${r.en}</p>
                            </div>
                             <div class="flex flex-col items-end gap-1">${tagsHtml}</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm mb-4 text-gray-600">
                            <div><i class="fas fa-car w-5 text-center text-gray-400"></i>${r.time}</div>
                            <div><i class="fas fa-tag w-5 text-center text-gray-400"></i>${r.price}</div>
                            <div><i class="fas fa-layer-group w-5 text-center text-gray-400"></i>${r.level}</div>
                            <div><i class="fas fa-clock w-5 text-center text-gray-400"></i>${r.hours}</div>
                        </div>
                        
                        <p class="text-sm text-gray-600 leading-relaxed mb-5 bg-slate-50 p-3 rounded-lg border border-slate-100">${r.desc}</p>
                        
                        <div class="flex gap-3">
                            <a href="${r.web}" target="_blank" class="flex-1 text-center border border-slate-300 text-slate-600 font-bold py-2.5 rounded-lg hover:bg-slate-50 transition-colors">
                                <i class="fas fa-globe mr-2"></i>官網
                            </a>
                            <a href="${r.map}" target="_blank" class="flex-1 text-center bg-primary text-white font-bold py-2.5 rounded-lg hover:bg-blue-600 transition-colors shadow-sm">
                                <i class="fas fa-location-arrow mr-2"></i>導航
                            </a>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
            
            document.getElementById('resort-modal').classList.remove('hidden'); 
        }

        function closeResortModal() {
            document.getElementById('resort-modal').classList.add('hidden');
        }

        (async () => {
            const data = await fetchSheetData();
            if(data.length > 0) { render(data); await fetchWeather(data); render(data); }
            // 標題已固定，不再需要讀取 CSV 更新
            const target = new Date("2026-01-04T12:00:00").getTime();
            setInterval(() => {
                const diff = target - new Date().getTime();
                const d = Math.floor(diff / (1000*60*60*24));
                const h = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
                document.getElementById('countdown').innerText = `倒數 ${d} 天 ${h} 時`;
            }, 1000);
        })();
    </script>
</body>
</html>
